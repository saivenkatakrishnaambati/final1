<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Solar System & CME Impact Simulator</title>

    <style>
        /* --- Global & View Management --- */
        * { box-sizing: border-box; }
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #000;
            color: #fff;
        }
        .view {
            display: none; /* Hide all views by default */
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }
        .view.active {
            display: block; /* Show only the active view */
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* --- View 1: Solar System Simulator --- */
        #solar-system-view .controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            padding: 20px 30px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            z-index: 100;
            backdrop-filter: blur(5px);
        }
        #solar-system-view .controls h1 { margin: 0 0 10px 0; font-size: 1.8em; color: #ffc700; }
        #solar-system-view .controls p { margin: 0 0 20px 0; max-width: 500px; line-height: 1.5; color: #ddd; }
        #solar-system-view #cme-button { padding: 12px 25px; font-size: 1em; font-weight: bold; color: #000; background-color: #ffc700; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s ease, transform 0.1s ease; }
        #solar-system-view #cme-button:hover { background-color: #ffd700; }
        #solar-system-view #cme-button:disabled { background-color: #555; color: #999; cursor: not-allowed; }
        #solar-system-view canvas.targeting-mode { cursor: crosshair; }

        /* --- View 2: Earth Impact --- */
        #earth-impact-view { background-color: #00000a; }
        #effects-popup {
            position: absolute; top: 50%; left: 30px; transform: translateY(-50%); background-color: rgba(10, 25, 47, 0.85);
            border: 2px solid orange; border-radius: 15px; padding: 25px; max-width: 450px; z-index: 200; text-align: left;
            backdrop-filter: blur(5px); visibility: hidden; opacity: 0; transition: opacity 0.7s ease-in-out, visibility 0.7s;
        }
        #effects-popup.visible { visibility: visible; opacity: 1; }
        #effects-popup h2 { margin-top: 0; color: orange; }
        #effects-popup p { line-height: 1.6; }

        /* --- View 3: Mars Impact --- */
        #mars-impact-view { background-color: #00000a; background-image: url('https://www.transparenttextures.com/patterns/stardust.png'); }
        #mars-impact-view #scene { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        #mars-impact-view #planet-label { position: absolute; top: calc(50% - 130px); left: 50%; transform: translateX(-50%); color: #ffffff; font-size: 20px; font-weight: bold; text-shadow: 0 0 10px rgba(255, 100, 100, 0.7); z-index: 5; letter-spacing: 2px; }
        #mars-impact-view #mars-container { position: relative; width: 180px; height: 180px; border-radius: 50%; overflow: hidden; z-index: 2; }
        #mars-impact-view #mars { width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #d66d3a, #a6422a, #6b2b1a); box-shadow: 0 0 40px #d66d3a, inset -25px -25px 40px rgba(0,0,0,0.6); z-index: 1; }
        #mars-impact-view #atmosphere { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 210px; height: 210px; border-radius: 50%; background: radial-gradient(circle, rgba(214, 109, 58, 0.2), rgba(173, 216, 230, 0) 70%); z-index: 3; transition: transform 1.5s cubic-bezier(0.19, 1, 0.22, 1); }
        #mars-impact-view #atmosphere.eroded { transform: translate(-50%, -50%) translateX(40px) scaleX(0.8) skewX(-20deg); transform-origin: center left; }
        #mars-impact-view #bow-shock { position: absolute; width: 250px; height: 400px; left: calc(50% - 245px); top: calc(50% - 200px); border-left: 3px solid rgba(255, 255, 255, 0.8); border-radius: 50%; opacity: 0; z-index: 4; }
        #mars-impact-view #bow-shock.active { animation: marsBowShockFlash 0.5s ease-out forwards; }
        @keyframes marsBowShockFlash { 0% { opacity: 0; transform: scale(1); box-shadow: 0 0 0px #fff; } 50% { opacity: 1; transform: scale(1.05); box-shadow: 0 0 30px 10px rgba(150, 200, 255, 0.5); } 100% { opacity: 0; transform: scale(1.1); box-shadow: 0 0 0px #fff; } }
        #mars-impact-view #mars-container.aurora-active::before, #mars-impact-view #mars-container.aurora-active::after { content: ''; position: absolute; width: 150px; height: 100px; filter: blur(15px); opacity: 0; z-index: 4; background: linear-gradient(90deg, transparent, rgba(0, 255, 150, 0.5), rgba(0, 100, 255, 0.4), rgba(150, 50, 200, 0.3), transparent); background-size: 200% 100%; animation: marsAuroraFlow 5s ease-in-out infinite alternate, marsAuroraFlicker 3s ease-in-out infinite alternate, marsAuroraFadeIn 1s forwards; }
        #mars-impact-view #mars-container.aurora-active::before { top: -50px; left: 50%; transform: translateX(-50%) rotate(15deg); transform-origin: center bottom; animation-delay: 0s, 0.2s, 0s; }
        #mars-impact-view #mars-container.aurora-active::after { bottom: -50px; left: 50%; transform: translateX(-50%) rotate(-20deg); transform-origin: center top; }
        @keyframes marsAuroraFadeIn { to { opacity: 1; } } @keyframes marsAuroraFlow { 0% { background-position: 0% 0%; } 100% { background-position: 100% 0%; } } @keyframes marsAuroraFlicker { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }
        #mars-impact-view .cme-particle { position: absolute; width: 3px; height: 3px; background-color: #ffcc00; border-radius: 50%; box-shadow: 0 0 10px #ffcc00, 0 0 20px #ffdd44; animation: mars-move-particle linear forwards; }
        @keyframes mars-move-particle { 0% { transform: translateX(0) scale(var(--scale)); opacity: 1; } 99% { opacity: 1; } 100% { transform: translateX(calc(50vw - 120px)) scale(var(--scale)); opacity: 0; } }
        #mars-impact-view #info-box { position: absolute; bottom: 20px; right: 20px; width: 320px; padding: 20px; background-color: rgba(0, 0, 0, 0.75); border: 1px solid #444; border-radius: 8px; color: #eee; z-index: 10; }
        #mars-impact-view #info-box h3 { margin-bottom: 10px; color: #ff8c00; border-bottom: 1px solid #555; padding-bottom: 5px; }
        #mars-impact-view #info-box p { margin-top: 10px; transition: opacity 0.8s ease-in-out; line-height: 1.4; }
        #mars-impact-view .hidden { opacity: 0; }

        /* --- View 4, 5, 6, 7: Gas/Ice Giant Impacts --- */
        .giant-impact-view { background-color: #000005; }
        .giant-impact-view .info-popup {
            position: absolute; top: 50%; left: 40px; transform: translateY(-50%); background-color: rgba(20, 5, 10, 0.85); padding: 25px;
            border-radius: 15px; max-width: 380px; color: #eee; backdrop-filter: blur(8px); opacity: 0;
            pointer-events: none; transition: opacity 0.5s ease-in-out; z-index: 20;
        }
        .giant-impact-view .info-popup.visible { opacity: 1; pointer-events: all; }
        .giant-impact-view .info-popup h2 { margin-top: 0; text-align: center; }
        .giant-impact-view .info-popup p { line-height: 1.7; }
        #jupiter-impact-view .info-popup { border: 1px solid #ee0979; box-shadow: 0 0 30px rgba(238, 9, 121, 0.3); }
        #jupiter-impact-view .info-popup h2 { color: #ff6a00; }
        #saturn-impact-view .info-popup { border: 1px solid #8f94fb; box-shadow: 0 0 30px rgba(143, 148, 251, 0.3); }
        #saturn-impact-view .info-popup h2 { color: #a3a8ff; }
        #neptune-impact-view .info-popup { border: 1px solid #0979ee; box-shadow: 0 0 30px rgba(9, 121, 238, 0.3); }
        #neptune-impact-view .info-popup h2 { color: #00aaff; }

        /* --- View 8: Uranus Impact --- */
        #uranus-impact-view { background-color: #000015; background-image: radial-gradient(circle at 10% 20%, rgba(255,255,255,0.05) 1px, transparent 0), radial-gradient(circle at 70% 80%, rgba(255,255,255,0.07) 1px, transparent 0), radial-gradient(circle at 40% 60%, rgba(255,255,255,0.03) 1px, transparent 0), url('https://www.transparenttextures.com/patterns/stardust.png'); background-size: 100% 100%, 100% 100%, 100% 100%, 100px 100px; }
        #uranus-impact-view #scene { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; perspective: 1500px; }
        #uranus-impact-view #planet-label { position: absolute; top: calc(50% - 200px); left: 50%; transform: translateX(-50%); color: #ffffff; font-size: 22px; font-weight: bold; text-shadow: 0 0 10px rgba(192, 227, 239, 0.7); z-index: 11; letter-spacing: 3px; }
        #uranus-impact-view #uranus-container { position: relative; width: 260px; height: 260px; display: flex; justify-content: center; align-items: center; z-index: 2; transform-style: preserve-3d; animation: uranusPlanetWobble 45s infinite linear; }
        @keyframes uranusPlanetWobble { 0% { transform: rotateZ(0deg) rotateY(0deg); } 50% { transform: rotateZ(-1deg) rotateY(5deg); } 100% { transform: rotateZ(0deg) rotateY(0deg); } }
        #uranus-impact-view #uranus { width: 260px; height: 260px; border-radius: 50%; position: relative; z-index: 2; background: repeating-linear-gradient(15deg, rgba(255,255,255,0.03) 0px, rgba(255,255,255,0.01) 1px, transparent 20px, transparent 40px), #c0e3ef; box-shadow: inset 15px 0px 40px rgba(212, 240, 247, 0.9), inset -25px -15px 60px rgba(0, 0, 0, 0.5), inset -5px -25px 20px rgba(0,0,0,0.2) blur(2px), -10px 10px 30px rgba(0, 0, 0, 0.5); transform-style: preserve-3d; overflow: hidden; }
        #uranus-impact-view #uranus::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(circle at 30% 35%, rgba(255, 255, 255, 0.35) 0%, rgba(255, 255, 255, 0.15) 30%, transparent 70%); filter: blur(8px); z-index: 3; }
        #uranus-impact-view #ring { position: absolute; width: 400px; height: 20px; border-radius: 50%; transform: rotateX(88deg) rotateZ(-10deg); transform-style: preserve-3d; filter: drop-shadow(0px 15px 10px rgba(0,0,0,0.4)); }
        #uranus-impact-view #ring::before, #uranus-impact-view #ring::after { content: ''; position: absolute; width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(ellipse at center, transparent 65%, rgba(120, 120, 130, 0.4) 65.5%, rgba(90, 90, 100, 0.5) 70%, rgba(70, 70, 80, 0.6) 75%, rgba(90, 90, 100, 0.5) 80%, rgba(120, 120, 130, 0.4) 84%, transparent 85%), radial-gradient(ellipse at center, transparent 78%, rgba(50, 50, 60, 0.7) 78.5%, rgba(30, 30, 40, 0.7) 81%, transparent 82%); filter: blur(0.5px); }
        #uranus-impact-view #ring::before { clip-path: polygon(0 0, 100% 0, 100% 50%, 0 50%); z-index: 1; }
        #uranus-impact-view #ring::after { clip-path: polygon(0 50%, 100% 50%, 100% 100%, 0 100%); z-index: 3; }
        #uranus-impact-view #atmosphere { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 320px; height: 320px; border-radius: 50%; background: radial-gradient(circle, rgba(192, 227, 239, 0.25), transparent 75%); filter: blur(3px); z-index: 4; transition: transform 1.5s cubic-bezier(0.19, 1, 0.22, 1); }
        #uranus-impact-view #atmosphere.eroded { transform: translate(-50%, -50%) translateX(50px) scaleX(0.75) skewX(-20deg); transform-origin: center left; }
        #uranus-impact-view #bow-shock { position: absolute; width: 350px; height: 500px; left: calc(50% - 320px); top: calc(50% - 250px); border-left: 3px solid rgba(255, 255, 255, 0.8); border-radius: 50%; opacity: 0; z-index: 5; }
        #uranus-impact-view #bow-shock.active { animation: uranusBowShockFlash 0.5s ease-out forwards; }
        @keyframes uranusBowShockFlash { 50% { opacity: 1; transform: scale(1.05); box-shadow: 0 0 30px 10px rgba(192, 227, 239, 0.4); } 100% { opacity: 0; transform: scale(1.1); } }
        #uranus-impact-view #uranus.aurora-active::after { content: ''; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 100px; height: 100px; border-radius: 50%; filter: blur(15px); opacity: 0; z-index: 3; background: linear-gradient(120deg, transparent 30%, rgba(255, 120, 180, 0.4) 45%, rgba(200, 100, 255, 0.5) 55%, rgba(120, 180, 255, 0.4) 65%, transparent 80%); background-size: 200% 200%; animation: uranusAuroraFlow 5s ease-in-out infinite alternate, uranusAuroraFlicker 3s ease-in-out infinite alternate, uranusAuroraFadeIn 1.5s forwards; }
        @keyframes uranusAuroraFadeIn { to { opacity: 0.8; } } @keyframes uranusAuroraFlow { 0% { background-position: 0% 50%; transform: translateX(-50%) translateY(0) rotate(0deg) scale(1); } 100% { background-position: 100% 50%; transform: translateX(-45%) translateY(5px) rotate(15deg) scale(1.1); } } @keyframes uranusAuroraFlicker { 0% { opacity: 0.6; } 50% { opacity: 0.9; } 100% { opacity: 0.6; } }
        #uranus-impact-view .cme-particle { position: absolute; width: 3px; height: 3px; background-color: #ffcc00; border-radius: 50%; box-shadow: 0 0 10px #ffcc00, 0 0 20px #ffdd44; animation: uranus-move-particle linear forwards, uranusParticleFadeIn 0.3s ease-out forwards; }
        @keyframes uranus-move-particle { 100% { transform: translateX(101vw) scale(var(--scale)); opacity: 0; } } @keyframes uranusParticleFadeIn { from { opacity: 0; } to { opacity: 1; } }
        #uranus-impact-view #info-box { position: absolute; bottom: 20px; right: 20px; width: 320px; padding: 20px; background-color: rgba(0, 0, 0, 0.85); border: 1px solid #555; border-radius: 8px; color: #eee; z-index: 10; transition: border-color 0.5s ease-in-out, box-shadow 0.5s ease-in-out; }
        #uranus-impact-view #info-box.impact-active { border-color: #ffa500; box-shadow: 0 0 15px 5px rgba(255, 165, 0, 0.7); }
        #uranus-impact-view #info-box h3 { margin-bottom: 10px; color: #c0e3ef; border-bottom: 1px solid #555; padding-bottom: 5px; }
        #uranus-impact-view #info-box p { margin-top: 10px; transition: opacity 0.8s ease-in-out; line-height: 1.4; font-size: 14px; }
        #uranus-impact-view .hidden { opacity: 0; }
        
        /* --- View 9: Mercury Impact --- */
        #mercury-impact-view { background: #000005; }
        #mercury-impact-view #impact-modal { display: none; position: absolute; top: 50%; left: 30px; transform: translateY(-50%); background-color: rgba(15, 5, 20, 0.85); padding: 20px; border-radius: 15px; border: 1px solid rgba(255, 77, 77, 0.5); z-index: 100; width: 90%; max-width: 350px; box-shadow: 0 5px 30px rgba(255, 77, 77, 0.4); text-align: center; backdrop-filter: blur(10px); }
        #mercury-impact-view #impact-modal h2 { margin-top: 0; color: #ff4d4d; font-size: 1.6em; text-shadow: 0 0 5px rgba(255, 77, 77, 0.7); }
        #mercury-impact-view #impact-modal p { font-size: 0.95em; line-height: 1.5; margin-bottom: 15px; text-align: left; padding: 0; color: #e0eaff; }
        #mercury-impact-view #impact-modal ul { list-style: none; padding: 0; margin: 10px 0 20px 0; text-align: left; }
        #mercury-impact-view #impact-modal ul li { margin-bottom: 10px; padding-left: 15px; position: relative; color: #fff; }
        #mercury-impact-view #impact-modal ul li::before { content: 'â€¢'; color: #ff4d4d; font-weight: bold; display: inline-block; width: 1em; margin-left: -1em; }
        #mercury-impact-view #controls-container { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 20; }
        #mercury-impact-view .btn { background: linear-gradient(45deg, #0077ff, #00aaff); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 0.9em; font-weight: bold; transition: transform 0.2s, box-shadow 0.2s, background 0.2s; box-shadow: 0 4px 15px rgba(0, 119, 255, 0.4); }
        #mercury-impact-view .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 119, 255, 0.6); background: linear-gradient(45deg, #0088ff, #00bbff); }
        #mercury-impact-view .btn:disabled { background: #4a5568; cursor: not-allowed; box-shadow: none; transform: none; }
        #mercury-impact-view #planet-label { position: absolute; top: 50%; left: 50%; transform: translate(-50%, calc(-50% - 130px)); padding: 5px 10px; color: #fff; background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 5px; font-size: 1.2em; font-weight: bold; letter-spacing: 2px; pointer-events: none; opacity: 0.8; z-index: 10; }

        /* --- View 10: Venus Impact --- */
        #venus-impact-view { background-color: #000; }
        #venus-impact-view #popup-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: flex-start; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.5s ease-in-out; z-index: 20; padding-left: 50px; }
        #venus-impact-view #popup-container.visible { opacity: 1; pointer-events: all; }
        #venus-impact-view #popup { background-color: rgba(10, 5, 0, 0.85); padding: 25px; border: 3px solid #ff8c00; border-radius: 20px; max-width: 400px; text-align: center; color: #eee; box-shadow: 0 0 25px rgba(255, 140, 0, 0.5); }
        #venus-impact-view #popup h2 { margin-top: 0; color: #ffaf4d; }
        #venus-impact-view #popup p { line-height: 1.6; }

    </style>
</head>
<body>

    <div id="solar-system-view" class="view">
        <div class="controls">
            <h1 id="title-text">3D Solar System Simulator</h1>
            <p id="instruction-text"><b>Left-click & drag</b> to rotate. <b>Scroll</b> to zoom. The view will stay centered on the Sun.<br>Click the button to target a planet with a CME.</p>
            <button id="cme-button">Enable Targeting</button>
        </div>
    </div>

    <div id="earth-impact-view" class="view">
        <div id="effects-popup">
            <h2>Effects of a CME on Earth</h2>
            <p>When the Sun releases a massive cloud of solar particles, it creates a solar storm that can hit our planet. This event energizes Earth's magnetic field, causing beautiful and intense auroras (Northern and Southern Lights) that are visible more widely. However, these powerful storms can also disrupt our technology by damaging satellites, interfering with GPS and radio communications, and even causing power grid failures on the ground.</p>
        </div>
    </div>

    <div id="mars-impact-view" class="view">
        <div id="scene">
            <h2 id="planet-label">Mars</h2>
            <div id="bow-shock"></div>
            <div id="mars-container">
                <div id="mars"></div>
                <div id="atmosphere"></div>
            </div>
        </div>
        <div id="info-box">
            <h3>CME Impact on Mars</h3>
            <p id="info-compress" class="hidden"><strong>Ionosphere Compression:</strong> The CME's plasma compresses Mars' thin ionosphere on the day side.</p>
            <p id="info-escape" class="hidden"><strong>Increased Ion Escape:</strong> This compression energizes atmospheric particles, increasing the rate at which ions escape into space.</p>
            <p id="info-heating" class="hidden"><strong>Atmospheric Heating & Aurora:</strong> Energetic particles cause heating and trigger beautiful, localized aurora emissions on Mars.</p>
            <p id="info-radiation" class="hidden"><strong>Enhanced Surface Radiation:</strong> With its thin atmosphere, a CME can significantly increase radiation levels on the Martian surface.</p>
        </div>
    </div>

    <div id="jupiter-impact-view" class="view giant-impact-view">
        <div class="info-popup">
            <h2>CME Impact on Jupiter</h2>
            <p>As the largest planet, Jupiter has the most powerful magnetic field in the solar system. When a CME hits, this magnetosphere channels solar particles to the poles, creating incredibly intense and permanent auroras that are hundreds of times more powerful than Earth's and larger than our entire planet.</p>
        </div>
    </div>
    
    <div id="saturn-impact-view" class="view giant-impact-view">
         <div class="info-popup">
            <h2>CME Impact on Saturn</h2>
            <p>Saturn possesses a powerful magnetic field that funnels the high-energy particles from the CME towards its poles. This interaction excites atmospheric gases like hydrogen, causing spectacular and intense ultraviolet and infrared auroras, which are far more powerful than Earth's Northern Lights.</p>
        </div>
    </div>

    <div id="uranus-impact-view" class="view">
         <div id="scene">
            <h2 id="planet-label">Uranus</h2>
            <div id="bow-shock"></div>
            <div id="uranus-container">
                <div id="uranus"></div>
                <div id="ring"></div>
                <div id="atmosphere"></div>
            </div>
        </div>
        <div id="info-box">
            <h3>CME Impact on Uranus</h3>
            <p id="info-distance" class="hidden"><strong>Extreme Distance:</strong> The impact is incredibly weak due to the vast distance from the Sun.</p>
            <p id="info-compress" class="hidden"><strong>Magnetosphere Compression:</strong> The solar wind compresses Uranus's unique, offset magnetic field.</p>
            <p id="info-aurora" class="hidden"><strong>Complex Auroras:</strong> This triggers complex auroral displays due to the planet's extreme axial tilt.</p>
        </div>
    </div>

    <div id="neptune-impact-view" class="view giant-impact-view">
        <div class="info-popup">
            <h2>CME Impact on Neptune</h2>
            <p>Neptune, an ice giant, possesses a magnetic field roughly 27 times more powerful than Earth's. While not as strong as Jupiter's, a CME impact can still drive spectacular auroras, particularly around its magnetic poles. These auroras are influenced by the planet's unique, tilted, and offset magnetic field, creating complex and dynamic displays.</p>
        </div>
    </div>
    
    <div id="mercury-impact-view" class="view">
        <div id="controls-container">
            <button id="mercury-launch-cme" class="btn" disabled>CME In Transit...</button>
        </div>
        <div id="planet-label">MERCURY</div>
        <div id="impact-modal">
            <h2>CME Impact Analysis</h2>
            <p style="text-align: center; color: #ffaf4d;">OBSERVED ENVIRONMENTAL CHANGES:</p>
            <ul>
                <li><strong>Magnetosphere Collapse:</strong> Dayside magnetic field disappears under plasma pressure, allowing direct particle impact.</li>
                <li><strong>Surface Sputtering:</strong> High-energy CME particles strike the surface, driving space weathering.</li>
                <li><strong>Exosphere Flaring:</strong> Tenuous atmosphere is instantly energized (fed plasma), causing a temporary, visible expansion and glow.</li>
            </ul>
            <button id="mercury-close-modal" class="btn">Return to Solar System</button>
        </div>
    </div>

    <div id="venus-impact-view" class="view">
        <div id="popup-container">
            <div id="popup">
                <h2>CME Impact on Venus</h2>
                <p>Unlike Earth, Venus lacks a global magnetic field. This means the Coronal Mass Ejection strikes its upper atmosphere directly, exciting atmospheric gases and creating a diffuse, glowing aurora that wraps around the planet.</p>
            </div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { FontLoader } from 'three/addons/loaders/FontLoader.js';
        import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';
        
        // --- State Management ---
        const state = {
            activeView: null,
            animationFrameId: null,
            intervalId: null,
            timeoutId: null,
        };

        const RETURN_DELAY = 10000; // 10 seconds

        // --- View Controller ---
        function switchView(viewName) {
            // 1. Cleanup current view
            if (state.animationFrameId) cancelAnimationFrame(state.animationFrameId);
            if (state.intervalId) clearInterval(state.intervalId);
            if (state.timeoutId) clearTimeout(state.timeoutId);
            
            state.animationFrameId = null;
            state.intervalId = null;
            state.timeoutId = null;

            // 2. Hide all views and clean up canvases
            document.querySelectorAll('.view').forEach(v => {
                v.classList.remove('active');
                const canvas = v.querySelector('canvas');
                if (canvas) canvas.remove();
            });

            // 3. Activate new view
            const targetView = document.getElementById(`${viewName}-view`);
            if (targetView) {
                targetView.classList.add('active');
                state.activeView = viewName;

                // 4. Initialize the new view's logic
                switch (viewName) {
                    case 'solar-system': initSolarSystem(); break;
                    case 'mercury-impact': initMercuryImpact(); break;
                    case 'venus-impact': initVenusImpact(); break;
                    case 'earth-impact': initEarthImpact(); break;
                    case 'mars-impact': initMarsImpact(); break;
                    case 'jupiter-impact': initJupiterImpact(); break;
                    case 'saturn-impact': initSaturnImpact(); break;
                    case 'uranus-impact': initUranusImpact(); break;
                    case 'neptune-impact': initNeptuneImpact(); break;
                    default:
                        console.error(`View initializer for '${viewName}' not found.`);
                        switchView('solar-system');
                }
            } else {
                console.error(`View '${viewName}-view' not found.`);
                switchView('solar-system'); // Fallback
            }
        }

        // --- Initializer for Solar System View ---
        function initSolarSystem() {
            const container = document.getElementById('solar-system-view');
            // ======== BASIC SETUP ========
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
            camera.position.set(0, 40, 90);
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);
            // ======== CAMERA CONTROLS ========
            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; controls.enablePan = false; controls.autoRotate = true;
            controls.autoRotateSpeed = 0.4; controls.minDistance = 10; controls.maxDistance = 200; controls.zoomSpeed = 3.5;
            // ======== LIGHTING ========
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.2);
            scene.add(ambientLight);
            const pointLight = new THREE.PointLight(0xffffff, 2, 500);
            scene.add(pointLight);
            // ======== STARS BACKGROUND ========
            const starVertices = [];
            for (let i = 0; i < 10000; i++) {
                const x = (Math.random() - 0.5) * 2000; const y = (Math.random() - 0.5) * 2000; const z = (Math.random() - 0.5) * 2000;
                starVertices.push(x, y, z);
            }
            const starGeometry = new THREE.BufferGeometry();
            starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
            const stars = new THREE.Points(starGeometry, new THREE.PointsMaterial({ color: 0xffffff, size: 0.1 }));
            scene.add(stars);
            // ======== SUN ========
            const sunGeometry = new THREE.SphereGeometry(4, 32, 32);
            const sunMaterial = new THREE.MeshBasicMaterial({ color: 0xff6600 });
            const sun = new THREE.Mesh(sunGeometry, sunMaterial);
            scene.add(sun);
            // ======== PLANETS ========
            const planetData = [
                { name: 'Mercury', radius: 0.5, distance: 8, speed: 0.040, color: 0xaaaaaa },
                { name: 'Venus', radius: 0.8, distance: 12, speed: 0.030, color: 0xa5a5a5 },
                { name: 'Earth', radius: 1, distance: 17, speed: 0.020, color: 0x4d96ff },
                { name: 'Mars', radius: 0.7, distance: 24, speed: 0.016, color: 0xff5733 },
                { name: 'Jupiter', radius: 3.5, distance: 35, speed: 0.008, color: 0xd3a17e },
                { name: 'Saturn', radius: 2.8, distance: 50, speed: 0.006, color: 0xf0e68c },
                { name: 'Uranus', radius: 1.8, distance: 65, speed: 0.004, color: 0xAFDBF5 },
                { name: 'Neptune', radius: 1.7, distance: 80, speed: 0.002, color: 0x3F5EBA },
            ];
            const planets = [];
            planetData.forEach(data => {
                const planetGroup = new THREE.Object3D();
                scene.add(planetGroup);
                const geometry = new THREE.SphereGeometry(data.radius, 32, 32);
                const material = new THREE.MeshStandardMaterial({ color: data.color, emissive: data.color, emissiveIntensity: 0.2 });
                const planet = new THREE.Mesh(geometry, material);
                planet.position.x = data.distance;
                planet.userData = data;
                planetGroup.add(planet);
                if (data.name === 'Saturn') {
                    const ringGeometry = new THREE.RingGeometry(data.radius + 1, data.radius + 3, 64);
                    const ringMaterial = new THREE.MeshBasicMaterial({ color: 0xaaaaaa, side: THREE.DoubleSide, transparent: true, opacity: 0.6 });
                    const ring = new THREE.Mesh(ringGeometry, ringMaterial);
                    ring.rotation.x = -Math.PI * 0.4;
                    planet.add(ring);
                }
                const orbitGeometry = new THREE.BufferGeometry().setFromPoints(new THREE.Path().absarc(0, 0, data.distance, 0, Math.PI * 2, false).getSpacedPoints(128));
                const orbit = new THREE.Line(orbitGeometry, new THREE.LineBasicMaterial({ color: 0x333333 }));
                orbit.rotation.x = Math.PI / 2;
                scene.add(orbit);
                planets.push({ ...data, group: planetGroup, mesh: planet });
            });
            // ======== CME LOGIC ========
            let cmeParticles;
            function initiateCME(targetPlanet) {
                const planetName = targetPlanet.userData.name.toLowerCase();
                const viewName = `${planetName}-impact`;
                switchView(viewName);
            }
            // ======== UI & CONTROLS ========
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();
            let isTargetingMode = false;
            const cmeButton = document.getElementById('cme-button');
            const instructionText = document.getElementById('instruction-text');
            cmeButton.addEventListener('click', () => {
                isTargetingMode = true; renderer.domElement.classList.add('targeting-mode');
                cmeButton.textContent = 'Awaiting Target...'; cmeButton.disabled = true;
                instructionText.innerHTML = 'Now click on any planet to launch the CME.'; controls.autoRotate = false;
            });
            const clickHandler = (event) => {
                if (!isTargetingMode) return;
                mouse.x = (event.clientX / window.innerWidth) * 2 - 1; mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);
                const planetMeshes = planets.map(p => p.mesh); const intersects = raycaster.intersectObjects(planetMeshes);
                if (intersects.length > 0) {
                    initiateCME(intersects[0].object);
                }
            };
            container.addEventListener('click', clickHandler);
            // ======== ANIMATION LOOP ========
            function animate() {
                state.animationFrameId = requestAnimationFrame(animate);
                planets.forEach(p => { p.group.rotation.y += p.speed * 0.1; p.mesh.rotation.y += 0.005; });
                controls.update();
                renderer.render(scene, camera);
            }
            animate();
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }
        
        // --- Initializer for Earth Impact View ---
        function initEarthImpact() {
            const container = document.getElementById('earth-impact-view');
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(15, 5, 25);
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);
            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; controls.autoRotate = true; controls.autoRotateSpeed = 0.3;
            scene.add(new THREE.AmbientLight(0xffffff, 0.1));
            const directionalLight = new THREE.DirectionalLight(0xffffff, 2.5);
            directionalLight.position.set(-50, 10, 0);
            scene.add(directionalLight);
            const textureLoader = new THREE.TextureLoader();
            const earthGroup = new THREE.Group();
            scene.add(earthGroup);
            const earthGeometry = new THREE.SphereGeometry(10, 64, 64);
            const earth = new THREE.Mesh(earthGeometry, new THREE.MeshPhongMaterial({
                map: textureLoader.load('https://raw.githubusercontent.com/turban/webgl-earth/master/images/2_no_clouds_4k.jpg'),
                bumpMap: textureLoader.load('https://raw.githubusercontent.com/turban/webgl-earth/master/images/elev_bump_4k.jpg'),
                bumpScale: 0.1,
                specularMap: textureLoader.load('https://raw.githubusercontent.com/turban/webgl-earth/master/images/water_4k.png'),
                specular: new THREE.Color('grey')
            }));
            earthGroup.add(earth);
            const cityLights = new THREE.Mesh(earthGeometry, new THREE.MeshBasicMaterial({ map: textureLoader.load('https://raw.githubusercontent.com/turban/webgl-earth/master/images/lights_4k.png'), blending: THREE.AdditiveBlending, transparent: true }));
            earthGroup.add(cityLights);
            const clouds = new THREE.Mesh(new THREE.SphereGeometry(10.15, 64, 64), new THREE.MeshPhongMaterial({ map: textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_clouds.png'), transparent: true, opacity: 0.6 }));
            earthGroup.add(clouds);
            const auroraMaterial = new THREE.ShaderMaterial({
                uniforms: { time: { value: 0.0 }, opacity: { value: 0.0 } },
                vertexShader: `uniform float time; varying vec2 vUv; void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`,
                fragmentShader: `uniform float time; uniform float opacity; varying vec2 vUv; float noise(vec2 p) { return fract(sin(dot(p, vec2(12.9898, 78.233))) * 43758.5453); } void main() { vec3 color = vec3(0.1, 1.0, 0.3); float intensity = pow(noise(vUv * 5.0 + time * 0.2), 2.0); float verticalFade = pow(sin(vUv.y * 3.14159), 0.5); gl_FragColor = vec4(color * intensity, intensity * verticalFade * opacity); }`,
                transparent: true, side: THREE.DoubleSide, blending: THREE.AdditiveBlending, depthWrite: false
            });
            const auroraNorth = new THREE.Mesh(new THREE.CylinderGeometry(10.5, 10.5, 4, 128, 64, true), auroraMaterial);
            auroraNorth.position.y = 8;
            earthGroup.add(auroraNorth);
            const auroraSouth = new THREE.Mesh(new THREE.CylinderGeometry(10.5, 10.5, 4, 128, 64, true), auroraMaterial);
            auroraSouth.position.y = -8; auroraSouth.rotation.x = Math.PI;
            earthGroup.add(auroraSouth);
            let cmeParticles; const cmeVelocities = [];
            function startCme() {
                const particleCount = 2000; const positions = new Float32Array(particleCount * 3);
                for (let i = 0; i < particleCount; i++) {
                    const i3 = i * 3;
                    positions[i3] = -80; positions[i3 + 1] = (Math.random() - 0.5) * 40; positions[i3 + 2] = (Math.random() - 0.5) * 40;
                    cmeVelocities.push(new THREE.Vector3(Math.random() * 0.1 + 0.3, 0, 0));
                }
                const geometry = new THREE.BufferGeometry();
                geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                cmeParticles = new THREE.Points(geometry, new THREE.PointsMaterial({ color: 0xff8c00, size: 0.2, blending: THREE.AdditiveBlending, transparent: true, opacity: 0.9 }));
                scene.add(cmeParticles);
            }
            const clock = new THREE.Clock();
            function animate() {
                state.animationFrameId = requestAnimationFrame(animate);
                const delta = clock.getDelta(); const elapsedTime = clock.getElapsedTime();
                earth.rotation.y += 0.1 * delta; cityLights.rotation.y += 0.1 * delta; clouds.rotation.y += 0.12 * delta;
                if (cmeParticles) {
                    const positions = cmeParticles.geometry.attributes.position;
                    for (let i = 0; i < positions.count; i++) {
                        const i3 = i * 3; positions.array[i3] += cmeVelocities[i].x; positions.array[i3+1] += cmeVelocities[i].y; positions.array[i3+2] += cmeVelocities[i].z;
                    }
                    positions.needsUpdate = true;
                }
                auroraMaterial.uniforms.time.value = elapsedTime;
                controls.update();
                renderer.render(scene, camera);
            }
            function startSimulation() {
                const effectsPopup = document.getElementById('effects-popup');
                startCme();
                setTimeout(() => { directionalLight.intensity = 5.0; setTimeout(() => { directionalLight.intensity = 2.5; }, 500); }, 3500);
                setTimeout(() => { auroraMaterial.uniforms.opacity.value = 1.0; effectsPopup.classList.add('visible'); }, 4500);
            }
            animate();
            startSimulation();
            state.timeoutId = setTimeout(() => switchView('solar-system'), RETURN_DELAY);
        }

        // --- Initializer for Mars Impact View ---
        function initMarsImpact() {
            const scene = document.getElementById('mars-impact-view').querySelector('#scene');
            const atmosphere = document.getElementById('mars-impact-view').querySelector('#atmosphere');
            const marsContainer = document.getElementById('mars-impact-view').querySelector('#mars-container');
            const bowShock = document.getElementById('mars-impact-view').querySelector('#bow-shock');
            function createParticle() {
                const particle = document.createElement('div');
                particle.className = 'cme-particle';
                const startY = Math.random() * window.innerHeight;
                const duration = (Math.random() * 0.5 + 1.2).toFixed(2);
                const scale = (Math.random() * 0.5 + 0.8).toFixed(2);
                particle.style.top = `${startY}px`; particle.style.left = '-10px';
                particle.style.setProperty('--scale', scale);
                particle.style.animationDuration = `${duration}s`;
                scene.appendChild(particle);
                setTimeout(() => { particle.remove(); }, duration * 1000);
            }
            state.intervalId = setInterval(createParticle, 20);
            setTimeout(() => bowShock.classList.add('active'), 1000);
            setTimeout(() => {
                atmosphere.classList.add('eroded');
                document.getElementById('info-compress').classList.remove('hidden');
                bowShock.classList.remove('active');
            }, 1200);
            setTimeout(() => document.getElementById('info-escape').classList.remove('hidden'), 1800);
            setTimeout(() => {
                marsContainer.classList.add('aurora-active');
                document.getElementById('info-heating').classList.remove('hidden');
                clearInterval(state.intervalId);
                state.intervalId = null;
            }, 2500);
            setTimeout(() => document.getElementById('info-radiation').classList.remove('hidden'), 3500);
            state.timeoutId = setTimeout(() => switchView('solar-system'), RETURN_DELAY);
        }
        
        // --- Generic Initializer for Gas/Ice Giants ---
        function initGiantImpact(viewId, planetConfig) {
            const container = document.getElementById(viewId);
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 3000);
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);
            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; controls.minDistance = planetConfig.camDist.min; controls.maxDistance = planetConfig.camDist.max;
            camera.position.set(...planetConfig.camPos);
            scene.add(new THREE.AmbientLight(0xffffff, 0.3));
            const sunLight = new THREE.DirectionalLight(0xffffff, 2.5);
            sunLight.position.set(-100, 20, 0);
            scene.add(sunLight);
            const planetGroup = new THREE.Group();
            planetGroup.rotation.x = planetConfig.tilt;
            const planet = new THREE.Mesh(new THREE.SphereGeometry(planetConfig.radius, 64, 64), new THREE.MeshStandardMaterial({ map: new THREE.TextureLoader().load(planetConfig.texture), roughness: 0.8 }));
            planetGroup.add(planet);
            if (planetConfig.rings) {
                const ringGeo = new THREE.RingGeometry(planetConfig.rings.inner, planetConfig.rings.outer, 128);
                const ringMat = new THREE.MeshBasicMaterial({ map: new THREE.TextureLoader().load(planetConfig.rings.texture), side: THREE.DoubleSide, transparent: true, opacity: 0.8 });
                const rings = new THREE.Mesh(ringGeo, ringMat);
                rings.rotation.x = -Math.PI / 2;
                planetGroup.add(rings);
            }
            scene.add(planetGroup);
            const auroraUniforms = { impact: { value: 0.0 }, time: { value: 0.0 } };
            const aurora = new THREE.Mesh(new THREE.SphereGeometry(planetConfig.radius + 0.2, 64, 64), new THREE.ShaderMaterial({
                uniforms: auroraUniforms, vertexShader: `varying vec3 vNormal; void main() { vNormal = normalize(normalMatrix * normal); gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`,
                fragmentShader: `uniform float time; uniform float impact; varying vec3 vNormal; float noise(vec2 st) { return fract(sin(dot(st.xy, vec2(12.9898, 78.233))) * 43758.5453); } void main() { float polarFactor = pow(abs(vNormal.y), 3.0); float auroraNoise = noise(vNormal.xz * 5.0 + time * 0.3); gl_FragColor = vec4(vec3(${planetConfig.auroraColor}), polarFactor * auroraNoise * impact * 2.0); }`,
                transparent: true, blending: THREE.AdditiveBlending, side: THREE.BackSide
            }));
            planetGroup.add(aurora);
            let cmeWave, hasImpacted = false;
            function launchCME() {
                const cmeGeo = new THREE.BufferGeometry();
                const positions = new Float32Array(25000 * 3);
                for (let i = 0; i < 25000; i++) {
                    const i3 = i * 3;
                    positions[i3] = -300 + (Math.random() - 0.5) * 20;
                    positions[i3+1] = (Math.random() - 0.5) * 100; positions[i3+2] = (Math.random() - 0.5) * 100;
                }
                cmeGeo.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
                cmeWave = new THREE.Points(cmeGeo, new THREE.PointsMaterial({ color: 0xffcc88, size: 0.5, blending: THREE.AdditiveBlending, transparent: true }));
                scene.add(cmeWave);
            }
            const clock = new THREE.Clock();
            function animate() {
                state.animationFrameId = requestAnimationFrame(animate);
                const delta = clock.getDelta(); planet.rotation.y += 0.05 * delta;
                auroraUniforms.time.value = clock.getElapsedTime();
                if (cmeWave) {
                    const positions = cmeWave.geometry.attributes.position.array;
                    let leadingEdgeX = -Infinity;
                    for (let i = 0; i < positions.length; i += 3) {
                        positions[i] += 120 * delta;
                        if (positions[i] > leadingEdgeX) leadingEdgeX = positions[i];
                    }
                    cmeWave.geometry.attributes.position.needsUpdate = true;
                    if (leadingEdgeX >= -planetConfig.radius && !hasImpacted) {
                        hasImpacted = true;
                        container.querySelector('.info-popup').classList.add('visible');
                    }
                    if(leadingEdgeX > 200) scene.remove(cmeWave);
                }
                if (hasImpacted && auroraUniforms.impact.value < 1.0) auroraUniforms.impact.value += 0.01;
                controls.update();
                renderer.render(scene, camera);
            }
            animate();
            launchCME();
            state.timeoutId = setTimeout(() => switchView('solar-system'), RETURN_DELAY);
        }

        // --- Initializers for each Gas/Ice Giant ---
        function initJupiterImpact() { initGiantImpact('jupiter-impact-view', { radius: 10, texture: 'https://cdn.jsdelivr.net/gh/jeromeetienne/threex.planets/images/jupiter_atmos_4k.jpg', tilt: 0.05, auroraColor: '0.3, 0.5, 1.0', camPos: [0, 8, 30], camDist: {min: 15, max: 150} }); }
        function initSaturnImpact() { initGiantImpact('saturn-impact-view', { radius: 9, texture: 'https://cdn.jsdelivr.net/gh/jeromeetienne/threex.planets/images/saturnmap.jpg', tilt: 0.4, auroraColor: '0.8, 0.2, 1.0', rings: {inner: 12, outer: 22, texture: 'https://cdn.jsdelivr.net/gh/jeromeetienne/threex.planets/images/saturnringcolor.gif'}, camPos: [20, 15, 60], camDist: {min: 25, max: 150} }); }
        function initNeptuneImpact() { initGiantImpact('neptune-impact-view', { radius: 8, texture: 'https://cdn.jsdelivr.net/gh/jeromeetienne/threex.planets/images/neptunemap.jpg', tilt: 0.48, auroraColor: '0.0, 0.5, 1.0', camPos: [0, 8, 25], camDist: {min: 12, max: 150} }); }

        // --- Initializer for Uranus Impact ---
        function initUranusImpact() {
            const scene = document.getElementById('uranus-impact-view').querySelector('#scene');
            const atmosphere = document.getElementById('uranus-impact-view').querySelector('#atmosphere');
            const uranus = document.getElementById('uranus-impact-view').querySelector('#uranus'); 
            const bowShock = document.getElementById('uranus-impact-view').querySelector('#bow-shock');
            const infoBox = document.getElementById('uranus-impact-view').querySelector('#info-box');
            function createParticle() {
                const particle = document.createElement('div');
                particle.className = 'cme-particle';
                const startY = Math.random() * window.innerHeight;
                const duration = (Math.random() * 1.5 + 2.0).toFixed(2);
                const scale = (Math.random() * 0.4 + 0.7).toFixed(2);
                particle.style.top = `${startY}px`; particle.style.left = '-10px';
                particle.style.setProperty('--scale', scale);
                particle.style.animationDuration = `${duration}s`;
                scene.appendChild(particle);
                setTimeout(() => { particle.remove(); }, duration * 1000);
            }
            state.intervalId = setInterval(createParticle, 30);
            setTimeout(() => { bowShock.classList.add('active'); infoBox.classList.add('impact-active'); }, 2000);
            setTimeout(() => { atmosphere.classList.add('eroded'); document.getElementById('info-distance').classList.remove('hidden'); bowShock.classList.remove('active'); }, 2200);
            setTimeout(() => { document.getElementById('info-compress').classList.remove('hidden'); }, 3000);
            setTimeout(() => { uranus.classList.add('aurora-active'); document.getElementById('info-aurora').classList.remove('hidden'); clearInterval(state.intervalId); state.intervalId = null; }, 3800);
            state.timeoutId = setTimeout(() => switchView('solar-system'), RETURN_DELAY);
        }

        // --- Initializer for Mercury Impact ---
        function initMercuryImpact() {
            const container = document.getElementById('mercury-impact-view');
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);
            const controls = new OrbitControls(camera, renderer.domElement);
            camera.position.set(0, 5, 20); controls.update();
            scene.add(new THREE.AmbientLight(0xffffff, 0.1));
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(-100, 10, 0); scene.add(directionalLight);
            const mercuryGroup = new THREE.Group();
            const MERCURY_RADIUS = 8;
            const mercury = new THREE.Mesh(new THREE.SphereGeometry(MERCURY_RADIUS, 64, 64), new THREE.MeshStandardMaterial({ color: 0x9f8c76, roughness: 0.9 }));
            mercuryGroup.add(mercury);
            scene.add(mercuryGroup);
            const exosphereMaterial = new THREE.ShaderMaterial({
                uniforms: { impactStrength: { value: 0.0 }, glowColor: { value: new THREE.Color(0x66ccff) } },
                vertexShader: `uniform float impactStrength; varying float vIntensity; varying vec3 vNormal; void main() { vNormal = normalize(normalMatrix * normal); vec3 transformed = position; float daysideFactor = max(0.0, -vNormal.x); transformed.x -= daysideFactor * impactStrength * 3.0; float nightsideFactor = max(0.0, vNormal.x); transformed += normal * pow(nightsideFactor, 2.0) * impactStrength * 5.0; vec3 cameraDirection = normalize(cameraPosition - position); vIntensity = pow(0.7 - dot(cameraDirection, normal), 2.0); gl_Position = projectionMatrix * modelViewMatrix * vec4(transformed, 1.0); }`,
                fragmentShader: `uniform float impactStrength; uniform vec3 glowColor; varying float vIntensity; varying vec3 vNormal; void main() { vec3 impactColor = mix(glowColor, vec3(1.0, 0.3, 0.0), impactStrength * 0.9); float opacity = vIntensity * (0.4 + impactStrength * 0.8); opacity = mix(opacity, opacity * (1.0 - impactStrength), max(0.0, -vNormal.x)); gl_FragColor = vec4(impactColor, opacity); }`,
                transparent: true, blending: THREE.AdditiveBlending,
            });
            const exosphere = new THREE.Mesh(new THREE.SphereGeometry(MERCURY_RADIUS * 1.5, 64, 64), exosphereMaterial);
            mercuryGroup.add(exosphere);
            let cme, cmeIsActive = false, impactTriggered = false;
            function launchCME() {
                if (cmeIsActive) return; cmeIsActive = true;
                const cmeGeometry = new THREE.BufferGeometry();
                const cmePositions = new Float32Array(5000 * 3);
                for (let i = 0; i < 5000*3; i+=3) { cmePositions[i] = -80 + (Math.random()-0.5)*10; cmePositions[i+1] = (Math.random()-0.5)*40; cmePositions[i+2] = (Math.random()-0.5)*40; }
                cmeGeometry.setAttribute('position', new THREE.Float32BufferAttribute(cmePositions, 3));
                cme = new THREE.Points(cmeGeometry, new THREE.PointsMaterial({ color: 0xffa040, size: 0.4, transparent: true, opacity: 0.9, blending: THREE.AdditiveBlending }));
                scene.add(cme);
            }
            function triggerImpact() {
                if (impactTriggered) return; impactTriggered = true;
                let t = 0;
                const impactAnimation = setInterval(() => { t += 0.01; exosphereMaterial.uniforms.impactStrength.value = 1.0 - t * t; if (t >= 1) { clearInterval(impactAnimation); scene.remove(cme); document.getElementById('impact-modal').style.display = 'block'; } }, 20);
            }
            function animate() {
                state.animationFrameId = requestAnimationFrame(animate);
                mercury.rotation.y += 0.001;
                if (cmeIsActive) {
                    const positions = cme.geometry.attributes.position.array;
                    let leadingEdgeX = -Infinity;
                    for (let i = 0; i < 5000*3; i += 3) { positions[i] += 0.5; if(positions[i] > leadingEdgeX) leadingEdgeX = positions[i]; }
                    cme.geometry.attributes.position.needsUpdate = true;
                    if (leadingEdgeX >= -MERCURY_RADIUS - 5 && !impactTriggered) triggerImpact();
                }
                controls.update();
                renderer.render(scene, camera);
            }
            document.getElementById('mercury-close-modal').onclick = () => switchView('solar-system');
            animate();
            launchCME();
            state.timeoutId = setTimeout(() => switchView('solar-system'), RETURN_DELAY + 5000); // Give more time for this one
        }
        
        // --- Initializer for Venus Impact ---
        function initVenusImpact() {
            const container = document.getElementById('venus-impact-view');
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(65, window.innerWidth / window.innerHeight, 0.1, 2000);
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);
            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            camera.position.set(0, 5, 18);
            scene.add(new THREE.AmbientLight(0xffffff, 0.2));
            const directionalLight = new THREE.DirectionalLight(0xffffff, 2.0);
            directionalLight.position.set(-1, 0.1, 0).normalize();
            scene.add(directionalLight);
            const venus = new THREE.Mesh(new THREE.SphereGeometry(4, 64, 64), new THREE.MeshStandardMaterial({ map: new THREE.TextureLoader().load('https://cdn.jsdelivr.net/gh/jeromeetienne/threex.planets/images/venusmap.jpg'), roughness: 0.9 }));
            scene.add(venus);
            const auroraUniforms = { time: { value: 0.0 }, impact: { value: 0.0 } };
            const aurora = new THREE.Mesh( new THREE.SphereGeometry(4.2, 64, 64), new THREE.ShaderMaterial({ uniforms: auroraUniforms, vertexShader: `varying vec3 vNormal; void main() { vNormal = normalize(normalMatrix * normal); gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`, fragmentShader: `uniform float time; uniform float impact; varying vec3 vNormal; float n(vec2 p){return fract(sin(dot(p,vec2(12.98,78.23)))*43758.5);} void main() { float rim=pow(1.0-abs(dot(vNormal,vec3(0,0,1))),2.5); vec3 c=mix(vec3(0,.5,.1),vec3(.8,0,.5),n(vNormal.xy*3.+time*.1)); gl_FragColor=vec4(c,rim*impact);}`, transparent: true, blending: THREE.AdditiveBlending, side: THREE.BackSide }) );
            scene.add(aurora);
            let cmeWave, hasImpacted = false;
            function launchCME() {
                const cmeGeo = new THREE.BufferGeometry();
                const positions = new Float32Array(30000 * 3);
                for (let i = 0; i < 30000*3; i+=3) { positions[i] = -100 + (Math.random()-0.5)*10; positions[i+1] = (Math.random()-0.5)*100; positions[i+2] = (Math.random()-0.5)*100; }
                cmeGeo.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
                cmeWave = new THREE.Points(cmeGeo, new THREE.PointsMaterial({ color: 0xffaa33, size: 2.0, sizeAttenuation: false, blending: THREE.AdditiveBlending, transparent: true, opacity: 0.8 }));
                scene.add(cmeWave);
            }
            const clock = new THREE.Clock();
            function animate() {
                state.animationFrameId = requestAnimationFrame(animate);
                const delta = clock.getDelta(); venus.rotation.y += 0.05 * delta;
                auroraUniforms.time.value = clock.getElapsedTime();
                if (cmeWave) {
                    const positions = cmeWave.geometry.attributes.position.array;
                    let leadingEdgeX = -Infinity;
                    for (let i = 0; i < positions.length; i+=3) { positions[i] += 50 * delta; if (positions[i] > leadingEdgeX) leadingEdgeX = positions[i]; }
                    cmeWave.geometry.attributes.position.needsUpdate = true;
                    if (leadingEdgeX >= -4 && !hasImpacted) {
                        hasImpacted = true;
                        scene.remove(cmeWave);
                        document.getElementById('popup-container').classList.add('visible');
                    }
                }
                if (hasImpacted && auroraUniforms.impact.value < 1.0) auroraUniforms.impact.value += 0.01;
                controls.update();
                renderer.render(scene, camera);
            }
            animate();
            launchCME();
            state.timeoutId = setTimeout(() => switchView('solar-system'), RETURN_DELAY);
        }

        // --- Start Application ---
        switchView('solar-system');
    </script>
</body>
</html>